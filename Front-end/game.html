<html>
  <head>
    <title>HTML 5 Game</title>
    <meta charset="utf-8">
    <script src=pixi.js></script>
  </head>
  <body>
    <script>
    var visible = [0,0,0,0,0,0,0,0];
    var Container = PIXI.Container;
    var AutoDetectRenderer = PIXI.autoDetectRenderer;
    var Loader = PIXI.loader;
    var Resources = PIXI.loader.resources;
    var Sprite = PIXI.Sprite;
    var TextureCache = PIXI.utils.TextureCache;
    var Rectangle = PIXI.Rectangle;
    var ParticleContainer = PIXI.particles.ParticleContainer;
    var Graphics = PIXI.Graphics;
    var Text = PIXI.Text;

    var renderer = AutoDetectRenderer(1024, 768, { transparent: true });
    document.body.appendChild(renderer.view);
    var mainScene=new Container();
    var stage=new Container();

    var sprite;
    var spriteCards=new Array(8);
    var ntt=new Array(8);

    Loader
    .add("assets/background.jpg")
    .add("assets/cardnumbers.json")
    .add("assets/cards.json")
    .on("progress",progress)
    .load(setup);

    function progress(loader, resource) {
      console.log("loading: " + resource.url);
      console.log("progress: " + loader.progress + "%");
    }

    function setup() {
      var textureBackground=TextureCache["assets/background.jpg"];

      var textureGuard=TextureCache["guard.png"];
      var texturePriest=TextureCache["priest.png"];
      var textureBaron=TextureCache["baron.png"];
      var textureHandmaid=TextureCache["handmaid.png"];
      var texturePrince=TextureCache["prince.png"];
      var textureKing=TextureCache["king.png"];
      var textureCountess=TextureCache["countess.png"];
      var texturePrincess=TextureCache["princess.png"];

      var textureVerso=TextureCache["verso.png"];

      ntt[0]=textureGuard;
      ntt[1]=texturePriest;
      ntt[2]=textureBaron;
      ntt[3]=textureHandmaid;
      ntt[4]=texturePrince;
      ntt[5]=textureKing;
      ntt[6]=textureCountess;
      ntt[7]=texturePrincess;

      for (let i=0;i<8;i++) {
        spriteCards[i]=new Sprite(textureVerso);
        spriteCards[i].interactive = true;
        spriteCards[i].anchor.set(0.5,0.5);
        spriteCards[i].alpha=0;

        spriteCards[i].on("mouseover", function(e){
          if (isVisible(i)) {
              this.alpha=0.75;
          }
        })

        spriteCards[i].on("mouseout", function(e){
          if (isVisible(i)) {
            this.alpha=1;
          }
        })

      }

      setVisible(1,true);
      /*spriteCards[0].x=450;
      spriteCards[0].y=800-100;*/

      spriteCards[0].x=921/2-127/2;
      spriteCards[0].y=679;

      spriteCards[1].x=921/2+127/2;
      spriteCards[1].y=679;

      spriteCards[2].rotation=Math.radians(-90);
      spriteCards[2].x=175/2+745;
      spriteCards[2].y=400;

      spriteCards[3].rotation=Math.radians(-90);
      spriteCards[3].x=175/2+745;
      spriteCards[3].y=400-127.5;

      spriteCards[4].rotation=Math.radians(180);
      spriteCards[4].x=921/2+127/2;
      spriteCards[4].y=175/2;

      spriteCards[5].rotation=Math.radians(180);
      spriteCards[5].x=921/2-127/2;
      spriteCards[5].y=175/2;

      spriteCards[6].rotation=Math.radians(90);
      spriteCards[6].x=175/2;
      spriteCards[6].y=400;

      spriteCards[7].rotation=Math.radians(90);
      spriteCards[7].x=175/2;
      spriteCards[7].y=400-127.5;

      sprite=spriteCards[0];
      //sprite.anchor.set(0.5,0.5);
      /*var textureGuard=TextureCache["verso.png"];
      var texture6=TextureCache["6.png"];


      sprite6=new Sprite(texture6);
      spriteGuard=new Sprite(textureGuard);/*/
      spriteBackground=new Sprite(textureBackground);
      mainScene.addChild(spriteBackground);

      for (let i=0;i<8;i++) {
        mainScene.addChild(spriteCards[i]);
      }
      stage.addChild(mainScene);

      addCardToPlayer(1,8);
      setVisible(0,true);
      state=play;
      gameLoop();
    }

    //Player (1-4) Card (1-8 -> guard-princess 9->verso)
    function addCardToPlayer(player,card) {
      console.log("addCardToPlayer : (player : "+player+") (card : "+card+")");
      switch (player) {
        default:
        case 1:
          spriteCards[1].texture=numberToTexture(card);
          setVisible(1,true);
          break;
        case 2:
          spriteCards[3].texture=numberToTexture(card);
          setVisible(3,true);
          break;
        case 3:
          spriteCards[5].texture=numberToTexture(card);
          setVisible(5,true);
          break;
        case 4:
          spriteCards[7].texture=numberToTexture(card);
          setVisible(7,true);
          break;
      }
    }

    //number : 1-8 -> guard-princess 9->verso)
    function numberToTexture(number) {
      console.log("numberToTexture : (number : "+number+")");
      return ntt[number-1];
    }


    //numcard : 0-7 visibility : true/false
    function setVisible(numcard,visibility) {
      visible[numcard]=visibility;
      if (visibility) {
          spriteCards[numcard].alpha=1;
      } else {
          spriteCards[numcard].alpha=0;
      }

    }

    //numcard : 0-7
    function isVisible(numcard) {
      return visible[numcard];
    }

    function gameLoop(test) {
      //Loop this function 60 times per second
      requestAnimationFrame(gameLoop);

      //Update the current game state:
      state();
      //sprite.rotation += 0.1;
      //Render the gameScene
      renderer.render(stage);
    }

    var explorerHit=false;
    function play() {
    }

    function keyboard(keyCode) {
      var key = {};
      key.code = keyCode;
      key.isDown = false;
      key.isUp = true;
      key.press = undefined;
      key.release = undefined;
      //The `downHandler`
      key.downHandler = function(event) {
      if (event.keyCode === key.code) {
        if (key.isUp && key.press) key.press();
          key.isDown = true;
          key.isUp = false;
        }
      event.preventDefault();
      };

      //The `upHandler`
      key.upHandler = function(event) {
      if (event.keyCode === key.code) {
        if (key.isDown && key.release) key.release();
          key.isDown = false;
          key.isUp = true;
        }
      event.preventDefault();
      };

      //Attach event listeners
      window.addEventListener(
        "keydown", key.downHandler.bind(key), false
      );
      window.addEventListener(
        "keyup", key.upHandler.bind(key), false
      );
      return key;
    }
    function hitTestRectangle(r1, r2) {
      //Define the variables we'll need to calculate
      var hit, combinedHalfWidths, combinedHalfHeights, vx, vy;

      //hit will determine whether there's a collision
      hit = false;

      //Find the center points of each sprite
      r1.centerX = r1.x + r1.width / 2;
      r1.centerY = r1.y + r1.height / 2;
      r2.centerX = r2.x + r2.width / 2;
      r2.centerY = r2.y + r2.height / 2;

      //Find the half-widths and half-heights of each sprite
      r1.halfWidth = r1.width / 2;
      r1.halfHeight = r1.height / 2;
      r2.halfWidth = r2.width / 2;
      r2.halfHeight = r2.height / 2;

      //Calculate the distance vector between the sprites
      vx = r1.centerX - r2.centerX;
      vy = r1.centerY - r2.centerY;

      //Figure out the combined half-widths and half-heights
      combinedHalfWidths = r1.halfWidth + r2.halfWidth;
      combinedHalfHeights = r1.halfHeight + r2.halfHeight;

      //Check for a collision on the x axis
      if (Math.abs(vx) < combinedHalfWidths) {

        //A collision might be occuring. Check for a collision on the y axis
        if (Math.abs(vy) < combinedHalfHeights) {

          //There's definitely a collision happening
          hit = true;
        } else {

          //There's no collision on the y axis
          hit = false;
        }
      } else {

        //There's no collision on the x axis
        hit = false;
      }

      //`hit` will be either `true` or `false`
      return hit;
      }
    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function contain(sprite, container) {

      var collision = undefined;

      //Left
      if (sprite.x < container.x) {
        sprite.x = container.x;
        collision = "left";
      }

      //Top
      if (sprite.y < container.y) {
        sprite.y = container.y;
        collision = "top";
      }

      //Right
      if (sprite.x + sprite.width > container.width) {
        sprite.x = container.width - sprite.width;
        collision = "right";
      }

      //Bottom
      if (sprite.y + sprite.height > container.height) {
        sprite.y = container.height - sprite.height;
        collision = "bottom";
      }

      //Return the `collision` value
      return collision;
    }

    // Converts from degrees to radians.
    Math.radians = function(degrees) {
      return degrees * Math.PI / 180;
    };

    // Converts from radians to degrees.
    Math.degrees = function(radians) {
      return radians * 180 / Math.PI;
    };
    </script>
  </body>
</html>
